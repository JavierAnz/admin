---
import Layout from "../layouts/Layout.astro";
import { getDbConnection } from "../lib/db";

interface Agencia {
  Cod_Agen: number;
  Nom_Agen: string;
}

let agencias: Agencia[] = [];
let connectionError = false;
let errorMessage = "";

// Cache configuration
const CACHE_TTL = 1000 * 60 * 60; // 1 hour
let agenciasCache: Agencia[] | null = null;
let lastFetch = 0;

// Fetch agencies with caching
try {
  const now = Date.now();

  if (agenciasCache && now - lastFetch < CACHE_TTL) {
    agencias = agenciasCache;
  } else {
    const pool = await getDbConnection();
    const result = await pool.request().query(`
      SELECT Cod_Agen, Nom_Agen 
      FROM agencias 
      WHERE Cod_Agen NOT IN (5,6,7,8,9,12,14,20,21) 
      ORDER BY Nom_Agen
    `);
    agencias = result.recordset as Agencia[];
    agenciasCache = agencias;
    lastFetch = now;
  }
} catch (e) {
  errorMessage =
    e instanceof Error ? e.message : "Error de conexión desconocido";
  console.error("Error al cargar agencias:", errorMessage);
  connectionError = true;

  // Fallback to cached data if available
  if (agenciasCache) {
    agencias = agenciasCache;
    connectionError = false;
  }
}

// Get error/success messages from URL params
const url = Astro.url;
const loginError = url.searchParams.get("error");
const loginSuccess = url.searchParams.get("success");
---

<Layout title="Acceso | OFIT">
  <main
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#3d3b3e] via-[#4a4749] to-[#3d3b3e] p-4 font-sans"
  >
    <div class="w-full max-w-md">
      <!-- Logo Section -->
      <div class="flex flex-col items-center mb-8">
        <img
          src="/logo.png"
          alt="OFIT Logo"
          class="h-auto w-40 rounded-lg shadow-2xl transition-transform hover:scale-105 duration-300"
          loading="eager"
        />
        <div class="h-1 w-20 bg-[#e91b27] mt-3 rounded-full"></div>
      </div>

      <!-- Login Card -->
      <div
        class="bg-white rounded-3xl shadow-2xl overflow-hidden border-b-8 border-[#ffd312] backdrop-blur-sm"
      >
        <!-- Connection Error Alert -->
        {
          connectionError && (
            <div
              class="bg-red-50 border-l-4 border-red-500 text-red-700 px-4 py-3 text-sm"
              role="alert"
              aria-live="polite"
            >
              <div class="flex items-center gap-2">
                <svg
                  class="w-5 h-5 flex-shrink-0"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span class="font-semibold">
                  Error de conexión con el servidor
                </span>
              </div>
            </div>
          )
        }

        <!-- Login Error Alert -->
        {
          loginError && (
            <div
              class="bg-amber-50 border-l-4 border-amber-500 text-amber-800 px-4 py-3 text-sm"
              role="alert"
              aria-live="polite"
            >
              <div class="flex items-center gap-2">
                <svg
                  class="w-5 h-5 flex-shrink-0"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span class="font-semibold">
                  {loginError === "invalid"
                    ? "Credenciales inválidas"
                    : "Error al iniciar sesión"}
                </span>
              </div>
            </div>
          )
        }

        <!-- Success Message -->
        {
          loginSuccess && (
            <div
              class="bg-green-50 border-l-4 border-green-500 text-green-800 px-4 py-3 text-sm"
              role="alert"
              aria-live="polite"
            >
              <div class="flex items-center gap-2">
                <svg
                  class="w-5 h-5 flex-shrink-0"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span class="font-semibold">{loginSuccess}</span>
              </div>
            </div>
          )
        }

        <!-- Form Section -->
        <div class="p-8">
          <form
            action="/api/auth/login"
            method="POST"
            class="space-y-6"
            id="loginForm"
          >
            <!-- Username Field -->
            <div class="form-group">
              <label
                for="nick"
                class="block text-[10px] font-black text-slate-500 uppercase mb-2 ml-1 tracking-widest"
              >
                Usuario (Nick)
              </label>
              <input
                type="text"
                id="nick"
                name="nick"
                required
                autocomplete="username"
                class="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-[#ffd312] focus:border-[#ffd312] outline-none transition-all font-semibold text-slate-700 placeholder:text-slate-400"
                placeholder="Introduzca su nombre de usuario"
                aria-required="true"
              />
            </div>

            <!-- Password Field -->
            <div class="form-group">
              <label
                for="pass"
                class="block text-[10px] font-black text-slate-500 uppercase mb-2 ml-1 tracking-widest"
              >
                Contraseña
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="pass"
                  name="pass"
                  required
                  autocomplete="current-password"
                  class="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-[#ffd312] focus:border-[#ffd312] outline-none transition-all font-semibold text-slate-700 placeholder:text-slate-400"
                  placeholder="••••••••"
                  aria-required="true"
                />
                <button
                  type="button"
                  id="togglePassword"
                  class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors"
                  aria-label="Mostrar contraseña"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Agency Selection -->
            <div class="form-group">
              <label
                for="id_agencia_vendedor"
                class="block text-[10px] font-black text-slate-500 uppercase mb-2 ml-1 tracking-widest"
              >
                Punto de Venta / Centro Operativo
              </label>
              <div class="relative">
                <select
                  id="id_agencia_vendedor"
                  name="id_agencia_vendedor"
                  required
                  class="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-[#ffd312] focus:border-[#ffd312] outline-none cursor-pointer appearance-none font-semibold text-slate-700 transition-all"
                  aria-required="true"
                >
                  <option value="">Seleccione su ubicación...</option>
                  {
                    agencias.map((ag) => (
                      <option value={ag.Cod_Agen}>{ag.Nom_Agen.trim()}</option>
                    ))
                  }
                </select>
                <div
                  class="absolute right-5 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <button
              type="submit"
              class="w-full bg-gradient-to-r from-[#3d3b3e] to-[#2d2b2e] hover:from-black hover:to-[#3d3b3e] text-[#ffd312] font-black py-5 rounded-2xl shadow-xl transition-all active:scale-[0.98] uppercase tracking-[0.2em] text-sm disabled:opacity-50 disabled:cursor-not-allowed"
              id="submitBtn"
            >
              <span id="btnText">Iniciar Sesión</span>
              <span id="btnLoading" class="hidden">
                <svg
                  class="animate-spin h-5 w-5 mx-auto"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
              </span>
            </button>
          </form>
        </div>

        <!-- Footer -->
        <div
          class="bg-slate-50 px-4 py-3 text-center border-t border-slate-200"
        >
          <p
            class="text-[9px] text-slate-400 font-bold uppercase tracking-widest"
          >
            Altek Systems © {new Date().getFullYear()}
          </p>
        </div>
      </div>
    </div>
  </main>

  <script>
    const togglePassword = document.getElementById("togglePassword");
    const passwordInput = document.getElementById("pass") as HTMLInputElement;

    if (togglePassword && passwordInput) {
      togglePassword.addEventListener("click", () => {
        const type = passwordInput.type === "password" ? "text" : "password";
        passwordInput.type = type;

        togglePassword.setAttribute(
          "aria-label",
          type === "password" ? "Mostrar contraseña" : "Ocultar contraseña",
        );
      });
    }

    const loginForm = document.getElementById("loginForm") as HTMLFormElement;
    const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
    const btnText = document.getElementById("btnText");
    const btnLoading = document.getElementById("btnLoading");

    if (loginForm && submitBtn) {
      loginForm.addEventListener("submit", () => {
        submitBtn.disabled = true;
        btnText?.classList.add("hidden");
        btnLoading?.classList.remove("hidden");
      });
    }

    const alerts = document.querySelectorAll('[role="alert"]');
    alerts.forEach((alert) => {
      setTimeout(() => {
        alert.classList.add("opacity-0", "transition-opacity", "duration-500");
        setTimeout(() => alert.remove(), 500);
      }, 5000);
    });
  </script>
</Layout>
