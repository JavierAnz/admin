---
import Layout from "../layouts/Layout.astro";

// Get error/success messages from URL params
const url = Astro.url;
const loginError = url.searchParams.get("error");
const loginSuccess = url.searchParams.get("success");
---

<Layout title="Acceso | OFIT">
  <main
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#3d3b3e] via-[#4a4749] to-[#3d3b3e] p-4 font-sans"
  >
    <div class="w-full max-w-md">
      <!-- Logo Section -->
      <div class="flex flex-col items-center mb-8">
        <img
          src="/logo.png"
          alt="OFIT Logo"
          class="h-auto w-40 rounded-lg shadow-2xl transition-transform hover:scale-105 duration-300"
          loading="eager"
        />
        <div class="h-1 w-20 bg-[#e91b27] mt-3 rounded-full"></div>
      </div>

      <!-- Login Card -->
      <div
        class="bg-white rounded-3xl shadow-2xl overflow-hidden border-b-8 border-[#ffd312] backdrop-blur-sm"
      >
        <!-- Login Error Alert -->
        {
          loginError && (
            <div
              class="bg-amber-50 border-l-4 border-amber-500 text-amber-800 px-4 py-3 text-sm"
              role="alert"
              aria-live="polite"
            >
              <span class="font-semibold">
                {loginError === "invalid"
                  ? "Credenciales inválidas"
                  : "Error al iniciar sesión"}
              </span>
            </div>
          )
        }

        <!-- Success Message -->
        {
          loginSuccess && (
            <div
              class="bg-green-50 border-l-4 border-green-500 text-green-800 px-4 py-3 text-sm"
              role="alert"
              aria-live="polite"
            >
              <span class="font-semibold">{loginSuccess}</span>
            </div>
          )
        }

        <!-- Form Section -->
        <div class="p-8">
          <form
            action="/api/auth/login"
            method="POST"
            class="space-y-6"
            id="loginForm"
          >
            <!-- Username -->
            <div>
              <label
                for="nick"
                class="block text-[10px] font-black text-slate-500 uppercase mb-2 ml-1 tracking-widest"
              >
                Usuario (Nick)
              </label>
              <input
                type="text"
                id="nick"
                name="nick"
                required
                autocomplete="username"
                class="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl"
              />
            </div>

            <!-- Password -->
            <div>
              <label
                for="pass"
                class="block text-[10px] font-black text-slate-500 uppercase mb-2 ml-1 tracking-widest"
              >
                Contraseña
              </label>
              <input
                type="password"
                id="pass"
                name="pass"
                required
                autocomplete="current-password"
                class="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl"
              />
            </div>

            <!-- Agency -->
            <div>
              <label
                for="id_agencia_vendedor"
                class="block text-[10px] font-black text-slate-500 uppercase mb-2 ml-1 tracking-widest"
              >
                Punto de Venta / Centro Operativo
              </label>
              <select
                id="id_agencia_vendedor"
                name="id_agencia_vendedor"
                required
                class="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl"
              >
                <option value="">Cargando agencias...</option>
              </select>
            </div>

            <!-- Submit -->
            <button
              type="submit"
              class="w-full bg-gradient-to-r from-[#3d3b3e] to-[#2d2b2e] text-[#ffd312] font-black py-5 rounded-2xl"
            >
              Iniciar Sesión
            </button>
          </form>
        </div>

        <!-- Footer -->
        <div class="bg-slate-50 px-4 py-3 text-center border-t">
          <p
            class="text-[9px] text-slate-400 font-bold uppercase tracking-widest"
          >
            Altek Systems © {new Date().getFullYear()}
          </p>
        </div>
      </div>
    </div>
  </main>

  <script>
    fetch("/api/agencias")
      .then((r) => r.json())
      .then((data) => {
        const select = document.getElementById("id_agencia_vendedor");
        select.innerHTML =
          '<option value="">Seleccione su ubicación...</option>';
        data.forEach((a) => {
          const opt = document.createElement("option");
          opt.value = a.Cod_Agen;
          opt.textContent = a.Nom_Agen.trim();
          select.appendChild(opt);
        });
      })
      .catch(() => {
        const select = document.getElementById("id_agencia_vendedor");
        select.innerHTML = '<option value="">Error cargando agencias</option>';
      });
  </script>
</Layout>
